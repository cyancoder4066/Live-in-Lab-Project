{% extends "base.html" %}

{% block content %}
<br>
<div class="container">
    <!-- Crack Detection Section -->
    <div class="card">
        <!-- Power Output Section -->
        <div class="card">
            <h3 style="color: #ff8c00;">Upload Image for Crack Detection</h3><br>
            <!-- Neon green heading -->
            <div id="crackDetection" class="container">

                <form class="form">
                  <span class="form-title">Upload your file</span>
                  <p class="form-paragraph">
                      File should be an image
                    </p>
                   <label for="file-input" class="drop-container">
                  <span class="drop-title">Drop files here</span>
                  or
                  <input type="file" accept="image/*" required="" id="file-input">
                </label>
                </form>

                <img id="preview" src="#" alt="Image Preview" style="display: none; max-width: 100%; margin-top: 20px; border-radius: 8px; border: 2px solid #ffcc00;"/>

    </div>
       <!-- Buttons -->
       <button id="detectCrackButton" class="action-button" style="margin-top: 20px;">Detect Crack</button>

       <canvas id="canvas" style="display: none; max-width: 100%; margin-top: 20px; border-radius: 8px; border: 2px solid #00FF7F;"></canvas>

       <a id="downloadButton" style="display: none; margin-top: 20px;" class="btn">Download Grayscale Image</a>
    
    
    </div>

    <!-- Alert Section -->
    <div id="alert" style="display: none;">
        <p id="alert-message">Alert message will appear here</p>
    </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const detectCrackButton = document.getElementById('detectCrackButton');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const results = document.getElementById('results');
    
    let currentImageData = null;

    // Preview the uploaded image
    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
            showLoading(true);
            
            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload image to server
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentImageData = data.image_data;
                    preview.src = data.image_data;
                    preview.style.display = 'block';
                    detectCrackButton.style.display = 'inline-block';
                    canvas.style.display = 'none';
                    results.style.display = 'none';
                    document.getElementById('downloadButton').style.display = 'none';
                    
                    showAlert('Image uploaded successfully!', 'info');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
                
            } catch (error) {
                console.error('Error uploading image:', error);
                showAlert('Error uploading image: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
    });

    // Process crack detection
    detectCrackButton.addEventListener('click', async () => {
        if (!currentImageData) {
            showAlert('Please upload an image first.', 'error');
            return;
        }
        
        showLoading(true);
        
        try {
            // Send image for processing
            const response = await apiCall('/api/process-crack-detection', {
                method: 'POST',
                body: JSON.stringify({
                    image_data: currentImageData
                })
            });
            
            if (response.success) {
                // For demo purposes, we'll process the image client-side
                // In a real application, the server would return the processed image
                processImageClientSide();
                
                // Display results
                results.style.display = 'block';
                document.getElementById('crack-status').textContent = 
                    `Cracks Detected: ${response.cracks_detected ? 'Yes' : 'No'}`;
                document.getElementById('confidence').textContent = 
                    `Confidence: ${(response.confidence * 100).toFixed(1)}%`;
                document.getElementById('crack-count').textContent = 
                    `Potential Crack Areas: ${response.crack_count}`;
                
                showAlert(response.message, response.cracks_detected ? 'error' : 'info');
            } else {
                throw new Error(response.error || 'Processing failed');
            }
            
        } catch (error) {
            console.error('Error processing crack detection:', error);
            showAlert('Error processing image: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    });

    // Client-side image processing (for demo purposes)
    function processImageClientSide() {
        if (preview.src) {
            const img = new Image();
            img.src = preview.src;

            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                // Convert to grayscale
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }

                // Apply thresholding for high contrast
                for (let i = 0; i < data.length; i += 4) {
                    const threshold = 128;
                    const value = data[i] > threshold ? 255 : 0;
                    data[i] = data[i + 1] = data[i + 2] = value;
                }

                // Update canvas with processed image
                ctx.putImageData(imageData, 0, 0);
                canvas.style.display = 'block';

                const downloadButton = document.getElementById("downloadButton");
                downloadButton.style.display = "inline-block";
                downloadButton.href = canvas.toDataURL();
                downloadButton.download = "processed_crack_detection.png";
            };
        }
    }
</script>
{% endblock %}