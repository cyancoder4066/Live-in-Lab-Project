{% extends "base.html" %}

{% block additional_css %}
<style>
    .surveillance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .camera-feed {
        background-color: #1b1b1b;
        border-radius: 8px;
        padding: 15px;
        border: 2px solid #333;
        position: relative;
    }
    
    .camera-feed.active {
        border-color: #00FF7F;
    }
    
    .camera-feed.alert {
        border-color: #ff4500;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { border-color: #ff4500; }
        51%, 100% { border-color: #333; }
    }
    
    .camera-video {
        width: 100%;
        height: 200px;
        background: linear-gradient(45deg, #0a0a0a, #1a1a1a);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 14px;
        position: relative;
        overflow: hidden;
    }
    
    .camera-video::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: scan 3s infinite;
    }
    
    @keyframes scan {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .camera-info {
        margin-top: 10px;
    }
    
    .camera-status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-online {
        background-color: #00FF7F;
        color: #000;
    }
    
    .status-offline {
        background-color: #ff4500;
        color: #fff;
    }
    
    .status-alert {
        background-color: #ff0000;
        color: #fff;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .control-panel {
        background-color: #1b1b1b;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .control-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .alert-log {
        background-color: #1b1b1b;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .alert-item {
        padding: 8px;
        margin-bottom: 5px;
        border-left: 3px solid #ff4500;
        background-color: #2a2a2a;
        border-radius: 3px;
        font-size: 14px;
    }
    
    .alert-item.high {
        border-left-color: #ff0000;
    }
    
    .alert-item.medium {
        border-left-color: #ff8c00;
    }
    
    .alert-item.low {
        border-left-color: #ffff00;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <h1>SURVEILLANCE SYSTEM</h1>
        <p style="color: #bcd8e9;">AI-powered monitoring and security system for hydro power plant</p>
        
        <!-- Camera Feeds Grid -->
        <div class="surveillance-grid">
            <div class="camera-feed" id="camera-1">
                <h4 style="color: #00FF7F;">Camera 1 - Main Entrance</h4>
                <div class="camera-video">
                    <span>ðŸ“¹ Live Feed Simulation</span>
                </div>
                <div class="camera-info">
                    <span class="camera-status status-online" id="status-1">ONLINE</span>
                    <span style="color: #00ffff; margin-left: 10px;">Resolution: 1080p</span>
                </div>
            </div>
            
            <div class="camera-feed" id="camera-2">
                <h4 style="color: #00FF7F;">Camera 2 - Turbine Hall</h4>
                <div class="camera-video">
                    <span>ðŸ“¹ Live Feed Simulation</span>
                </div>
                <div class="camera-info">
                    <span class="camera-status status-online" id="status-2">ONLINE</span>
                    <span style="color: #00ffff; margin-left: 10px;">Resolution: 1080p</span>
                </div>
            </div>
            
            <div class="camera-feed" id="camera-3">
                <h4 style="color: #00FF7F;">Camera 3 - Dam Structure</h4>
                <div class="camera-video">
                    <span>ðŸ“¹ Live Feed Simulation</span>
                </div>
                <div class="camera-info">
                    <span class="camera-status status-online" id="status-3">ONLINE</span>
                    <span style="color: #00ffff; margin-left: 10px;">Resolution: 4K</span>
                </div>
            </div>
            
            <div class="camera-feed" id="camera-4">
                <h4 style="color: #00FF7F;">Camera 4 - Control Room</h4>
                <div class="camera-video">
                    <span>ðŸ“¹ Live Feed Simulation</span>
                </div>
                <div class="camera-info">
                    <span class="camera-status status-online" id="status-4">ONLINE</span>
                    <span style="color: #00ffff; margin-left: 10px;">Resolution: 1080p</span>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <h3 style="color: #00FF7F;">Surveillance Controls</h3>
            <div class="control-row">
                <button onclick="toggleAllCameras()" class="action-button">Toggle All Cameras</button>
                <button onclick="simulateMotionDetection()" class="action-button">Simulate Motion Detection</button>
                <button onclick="simulateIntrusionAlert()" class="action-button">Simulate Intrusion Alert</button>
                <button onclick="resetAllAlerts()" class="action-button">Reset All Alerts</button>
            </div>
            <div class="control-row">
                <button onclick="startRecording()" class="action-button">Start Recording All</button>
                <button onclick="stopRecording()" class="action-button">Stop Recording</button>
                <button onclick="exportFootage()" class="action-button">Export Footage</button>
            </div>
        </div>
        
        <!-- Alert Log -->
        <div class="alert-log">
            <h3 style="color: #00FF7F;">Security Alert Log</h3>
            <div id="alert-log-content">
                <div class="alert-item low">
                    <strong>[${new Date().toLocaleTimeString()}]</strong> System initialized - All cameras online
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Section -->
    <div id="alert" style="display: none;">
        <p id="alert-message">Surveillance alert will appear here</p>
    </div>
    
    <!-- Loading indicator -->
    <div id="loading" class="loading" style="display: none;"></div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    let cameras = [
        { id: 1, name: 'Main Entrance', status: 'online', recording: false },
        { id: 2, name: 'Turbine Hall', status: 'online', recording: false },
        { id: 3, name: 'Dam Structure', status: 'online', recording: false },
        { id: 4, name: 'Control Room', status: 'online', recording: false }
    ];
    
    let isRecording = false;
    let alertCount = 1;

    // Toggle all cameras on/off
    function toggleAllCameras() {
        const allOnline = cameras.every(cam => cam.status === 'online');
        
        cameras.forEach(camera => {
            camera.status = allOnline ? 'offline' : 'online';
            updateCameraStatus(camera.id, camera.status);
        });
        
        const action = allOnline ? 'disabled' : 'enabled';
        addAlertLog(`All cameras ${action}`, 'medium');
        showAlert(`All cameras have been ${action}`, 'info');
    }

    // Update camera status display
    function updateCameraStatus(cameraId, status) {
        const statusElement = document.getElementById(`status-${cameraId}`);
        const cameraFeed = document.getElementById(`camera-${cameraId}`);
        
        statusElement.className = `camera-status status-${status}`;
        statusElement.textContent = status.toUpperCase();
        
        if (status === 'alert') {
            cameraFeed.classList.add('alert');
        } else {
            cameraFeed.classList.remove('alert');
            cameraFeed.classList.toggle('active', status === 'online');
        }
    }

    // Simulate motion detection
    function simulateMotionDetection() {
        const randomCamera = cameras[Math.floor(Math.random() * cameras.length)];
        
        if (randomCamera.status === 'online') {
            updateCameraStatus(randomCamera.id, 'alert');
            addAlertLog(`Motion detected on Camera ${randomCamera.id} - ${randomCamera.name}`, 'medium');
            showAlert(`Motion detected on ${randomCamera.name}!`, 'info');
            
            // Reset after 5 seconds
            setTimeout(() => {
                updateCameraStatus(randomCamera.id, 'online');
            }, 5000);
        } else {
            showAlert('Cannot detect motion - camera is offline', 'error');
        }
    }

    // Simulate intrusion alert
    function simulateIntrusionAlert() {
        const randomCamera = cameras[Math.floor(Math.random() * cameras.length)];
        
        if (randomCamera.status === 'online') {
            updateCameraStatus(randomCamera.id, 'alert');
            addAlertLog(`SECURITY BREACH: Unauthorized access detected on Camera ${randomCamera.id} - ${randomCamera.name}`, 'high');
            showAlert(`SECURITY ALERT: Unauthorized access detected on ${randomCamera.name}!`, 'error');
            
            // Keep alert status for longer
            setTimeout(() => {
                updateCameraStatus(randomCamera.id, 'online');
            }, 10000);
        } else {
            showAlert('Cannot detect intrusion - camera is offline', 'error');
        }
    }

    // Reset all alerts
    function resetAllAlerts() {
        cameras.forEach(camera => {
            if (camera.status !== 'offline') {
                camera.status = 'online';
                updateCameraStatus(camera.id, 'online');
            }
        });
        
        addAlertLog('All alerts cleared by operator', 'low');
        showAlert('All alerts have been cleared', 'info');
    }

    // Start recording all cameras
    function startRecording() {
        if (isRecording) {
            showAlert('Recording is already in progress', 'info');
            return;
        }
        
        const onlineCameras = cameras.filter(cam => cam.status === 'online' || cam.status === 'alert');
        
        if (onlineCameras.length === 0) {
            showAlert('No cameras online to record', 'error');
            return;
        }
        
        isRecording = true;
        onlineCameras.forEach(camera => {
            camera.recording = true;
        });
        
        addAlertLog(`Recording started on ${onlineCameras.length} cameras`, 'low');
        showAlert(`Started recording on ${onlineCameras.length} cameras`, 'info');
    }

    // Stop recording
    function stopRecording() {
        if (!isRecording) {
            showAlert('No recording in progress', 'info');
            return;
        }
        
        isRecording = false;
        cameras.forEach(camera => {
            camera.recording = false;
        });
        
        addAlertLog('Recording stopped on all cameras', 'low');
        showAlert('Recording stopped on all cameras', 'info');
    }

    // Export footage (simulation)
    function exportFootage() {
        if (!cameras.some(cam => cam.recording)) {
            showAlert('No recorded footage available', 'error');
            return;
        }
        
        showLoading(true);
        
        // Simulate export process
        setTimeout(() => {
            showLoading(false);
            addAlertLog('Footage export completed - Download link sent to admin', 'low');
            showAlert('Footage exported successfully! Download link will be available shortly.', 'info');
        }, 3000);
    }

    // Add entry to alert log
    function addAlertLog(message, priority = 'low') {
        const logContent = document.getElementById('alert-log-content');
        const alertItem = document.createElement('div');
        alertItem.className = `alert-item ${priority}`;
        alertItem.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        
        // Add to top of log
        logContent.insertBefore(alertItem, logContent.firstChild);
        
        // Keep only last 10 entries
        while (logContent.children.length > 10) {
            logContent.removeChild(logContent.lastChild);
        }
        
        alertCount++;
    }

    // Simulate random camera events
    function simulateRandomEvents() {
        const events = [
            () => simulateMotionDetection(),
            () => {
                const camera = cameras[Math.floor(Math.random() * cameras.length)];
                if (Math.random() > 0.8) {
                    camera.status = 'offline';
                    updateCameraStatus(camera.id, 'offline');
                    addAlertLog(`Camera ${camera.id} - ${camera.name} went offline`, 'medium');
                }
            },
            () => {
                addAlertLog('Routine maintenance check completed', 'low');
            }
        ];
        
        // Random event every 10-30 seconds
        setTimeout(() => {
            if (Math.random() > 0.7) {
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                randomEvent();
            }
            simulateRandomEvents();
        }, Math.random() * 20000 + 10000);
    }

    // Initialize surveillance system
    document.addEventListener('DOMContentLoaded', function() {
        // Start random event simulation
        simulateRandomEvents();
        
        showAlert('Surveillance system initialized - All cameras online', 'info');
        
        // Update camera status periodically
        setInterval(() => {
            cameras.forEach(camera => {
                // Simulate occasional offline cameras coming back online
                if (camera.status === 'offline' && Math.random() > 0.9) {
                    camera.status = 'online';
                    updateCameraStatus(camera.id, 'online');
                    addAlertLog(`Camera ${camera.id} - ${camera.name} back online`, 'low');
                }
            });
        }, 5000);
    });
</script>
{% endblock %}